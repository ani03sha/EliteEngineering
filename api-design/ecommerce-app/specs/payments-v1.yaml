openapi: 3.0.4
info:
    title: Payments Service API
    version: 1.0.0
    description: API for processing payments, managing payment methods, and handling refunds
servers:
    - url: http://localhost:8001/v1
      description: Local Server
    - url: https://anirudhology.com/payments/v1
      description: Production Server

# Core components
components:
    schemas:
        # Payment Models
        Payment:
            type: object
            required:
                - id
                - orderId
                - amount
                - currency
                - status
            properties:
                id:
                    type: string
                    format: uuid
                    example: "pay_1234567890abcdef"
                    description: Unique payment identifier
                orderId:
                    type: string
                    format: uuid
                    description: Reference to the associated order
                amount:
                    type: integer
                    minimum: 0
                    description: Amount in smallest currency unit (e.g., cents)
                    example: 2999
                currency:
                    type: string
                    pattern: "^[A-Z]{3}$"
                    example: "INR"
                    description: ISO 4217 currency code
                status:
                    type: string
                    enum:
                        - pending
                        - authorized
                        - captured
                        - partially_refunded
                        - refunded
                        - failed
                        - disputed
                        - canceled
                    description: Current payment status
                paymentMethodId:
                    type: string
                    format: uuid
                    description: Saved payment method used
                customerId:
                    type: string
                    format: uuid
                    description: Customer who made the payment
                description:
                    type: string
                    example: "Order #12345 - Premium Subscription"
                metadata:
                    type: object
                    additionalProperties:
                        type: string
                    description: Custom key-value pairs
                statementDescriptor:
                    type: string
                    maxLength: 22
                    description: Appears on customer's statement
                receiptEmail:
                    type: string
                    format: email
                feeAmount:
                    type: integer
                    readOnly: true
                    description: Processing fee deducted from amount
                netAmount:
                    type: integer
                    readOnly: true
                    description: Amount after fees (amount - fee)
                capturedAmount:
                    type: integer
                    readOnly: true
                    description: Amount already captured
                refundedAmount:
                    type: integer
                    readOnly: true
                    description: Amount refunded to date
                paymentMethodDetails:
                    $ref: "#/components/schemas/PaymentMethodDetails"
                error:
                    $ref: "#/components/schemas/PaymentError"
                createdAt:
                    type: string
                    format: date-time
                    readOnly: true
                updatedAt:
                    type: string
                    format: date-time
                    readOnly: true

        PaymentIntent:
            type: object
            required:
                - id
                - clientSecret
                - status
                - amount
                - currency
            properties:
                id:
                    type: string
                    format: uuid
                    readOnly: true
                clientSecret:
                    type: string
                    description: Secret for client-side confirmation
                    readOnly: true
                    example: "pi_123_secret_456"
                orderId:
                    type: string
                    format: uuid
                reservationId:
                    type: string
                    format: uuid
                    description: "Inventory reservation id tied to the order"
                amount:
                    type: integer
                    description: "Amount in smallest currency unit"
                currency:
                    type: string
                    pattern: "^[A-Z]{3}$"
                status:
                    type: string
                    enum:
                        - requires_payment_method
                        - requires_confirmation
                        - requires_action
                        - processing
                        - requires_capture
                        - captured
                        - canceled
                        - succeeded
                        - failed
                paymentMethodTypes:
                    type: array
                    items:
                        type: string
                        enum:
                            [card, bank_transfer, apple_pay, google_pay, paypal]
                captureMethod:
                    type: string
                    enum:
                        - automatic
                        - manual
                    default: automatic
                createdAt:
                    type: string
                    format: date-time
                updatedAt:
                    type: string
                    format: date-time

        # Payment Method Models
        PaymentMethod:
            type: object
            discriminator:
                propertyName: type
            required:
                - id
                - type
                - customerId
            properties:
                id:
                    type: string
                    format: uuid
                type:
                    type: string
                    enum: [card, bank_account, digital_wallet]
                customerId:
                    type: string
                    format: uuid
                isDefault:
                    type: boolean
                    default: false
                metadata:
                    type: object
                    additionalProperties:
                        type: string
                createdAt:
                    type: string
                    format: date-time
                    readOnly: true

        CardPaymentMethod:
            allOf:
                - $ref: "#/components/schemas/PaymentMethod"
                - type: object
                  properties:
                    type:
                        type: string
                        enum: [card]
                        default: card
                    brand:
                        type: string
                        enum: [visa, mastercard, amex, discover, diners, jcb]
                    last4:
                        type: string
                        pattern: '^\d{4}$'
                    expMonth:
                        type: integer
                        minimum: 1
                        maximum: 12
                    expYear:
                        type: integer
                        minimum: 2024
                        maximum: 2034
                    country:
                        type: string
                        pattern: "^[A-Z]{2}$"
                    funding:
                        type: string
                        enum: [credit, debit, prepaid, unknown]

        # Refund Models
        Refund:
            type: object
            required:
                - id
                - paymentId
                - amount
                - reason
                - status
            properties:
                id:
                    type: string
                    format: uuid
                paymentId:
                    type: string
                    format: uuid
                amount:
                    type: integer
                    minimum: 1
                currency:
                    type: string
                    pattern: "^[A-Z]{3}$"
                reason:
                    type: string
                    enum:
                        - duplicate
                        - fraudulent
                        - requested_by_customer
                        - product_unsatisfactory
                        - other
                status:
                    type: string
                    enum:
                        - pending
                        - succeeded
                        - failed
                        - canceled
                failureReason:
                    type: string
                    enum:
                        [
                            lost_or_stolen_card,
                            expired_card,
                            insufficient_funds,
                            suspected_fraud,
                        ]
                receiptNumber:
                    type: string
                    readOnly: true
                createdAt:
                    type: string
                    format: date-time
                    readOnly: true

        # Webhook Models
        PaymentWebhook:
            type: object
            required:
                - id
                - type
                - data
                - created
            properties:
                id:
                    type: string
                    example: "evt_123"
                type:
                    type: string
                    example: "payment.succeeded"
                data:
                    type: object
                    properties:
                        object:
                            type: object
                            description: Payment object
                created:
                    type: integer
                    format: int64
                    description: Unix timestamp
                apiVersion:
                    type: string
                    example: "2023-10-16"

        # Request/Response Models
        CreatePaymentRequest:
            type: object
            required:
                - orderId
                - amount
                - currency
            properties:
                orderId:
                    type: string
                    format: uuid
                amount:
                    type: integer
                    minimum: 50 # Minimum $0.50
                currency:
                    type: string
                    pattern: "^[A-Z]{3}$"
                paymentMethodId:
                    type: string
                    format: uuid
                customerId:
                    type: string
                    format: uuid
                description:
                    type: string
                metadata:
                    type: object
                    additionalProperties:
                        type: string
                captureMethod:
                    type: string
                    enum: [automatic, manual]
                    default: automatic
                setupFutureUsage:
                    type: string
                    enum: [on_session, off_session]
                    description: Save payment method for future use
                receiptEmail:
                    type: string
                    format: email
                applicationFeeAmount:
                    type: integer
                    description: Fee amount for platform
                transferData:
                    type: object
                    properties:
                        destination:
                            type: string
                            format: uuid
                        amount:
                            type: integer

        CreateRefundRequest:
            type: object
            required:
                - paymentId
                - amount
            properties:
                paymentId:
                    type: string
                    format: uuid
                amount:
                    type: integer
                    minimum: 1
                reason:
                    type: string
                    enum:
                        - duplicate
                        - fraudulent
                        - requested_by_customer
                        - product_unsatisfactory
                        - other
                metadata:
                    type: object
                    additionalProperties:
                        type: string

        # Error Models
        PaymentError:
            type: object
            properties:
                code:
                    type: string
                    enum:
                        - PAYMENT_METHOD_REQUIRED
                        - PAYMENT_REQUIRES_ACTION
                        - PAYMENT_FAILED
                        - DUPLICATE_PAYMENT
                        - RESERVATION_EXPIRED
                        - INVALID_PAYMENT_INTENT_STATE
                        - GATEWAY_ERROR
                declineCode:
                    type: string
                    example: "card_not_supported"
                message:
                    type: string
                    example: "Your card was declined."
                param:
                    type: string
                    example: "cvc"

        # Supporting Models
        PaymentMethodDetails:
            type: object
            properties:
                type:
                    type: string
                    enum: [card, bank_transfer, wallet]
                card:
                    type: object
                    properties:
                        brand:
                            type: string
                        last4:
                            type: string
                        country:
                            type: string
                bankTransfer:
                    type: object
                    properties:
                        bankName:
                            type: string
                        last4:
                            type: string

    parameters:
        PaymentId:
            name: paymentId
            in: path
            required: true
            schema:
                type: string
                format: uuid
            description: Unique payment identifier
            example: "pay_1234567890abcdef"

        RefundId:
            name: refundId
            in: path
            required: true
            schema:
                type: string
                format: uuid

        PaymentIntentId:
            name: paymentIntentId
            in: path
            required: true
            schema:
                type: string
                format: uuid

        CustomerIdParam:
            name: customerId
            in: path
            required: true
            schema:
                type: string
                format: uuid

        # Pagination and Filtering
        PaginationLimit:
            name: limit
            in: query
            schema:
                type: integer
                default: 20
                maximum: 100
            description: Maximum number of results to return

        PaginationOffset:
            name: offset
            in: query
            schema:
                type: integer
                default: 0
                minimum: 0
            description: Number of results to skip

        CreatedAfter:
            name: createdAfter
            in: query
            schema:
                type: string
                format: date-time
            description: Filter payments created after this timestamp

        StatusFilter:
            name: status
            in: query
            schema:
                type: string
                enum: [pending, succeeded, failed, canceled]
            description: Filter by payment status

        # Idempotency
        IdempotencyKey:
            name: Idempotency-Key
            in: header
            required: true
            scope: 7 days
            schema:
                type: string
                description: |
                    Key for ensuring idempotent requests. 
                    Recommended: UUID or other unique string.

    headers:
        WebhookSignature:
            description: HMAC signature of webhook payload
            schema:
                type: string
            required: true

    responses:
        NotFound:
            description: Resource not found
            content:
                application/json:
                    schema:
                        type: object
                        properties:
                            code:
                                type: string
                                example: "not_found"
                            message:
                                type: string
                                example: "The requested resource was not found"

        Unauthorized:
            description: Authentication required or invalid
            content:
                application/json:
                    schema:
                        type: object
                        properties:
                            code:
                                type: string
                                example: "unauthorized"
                            message:
                                type: string
                                example: "Authentication is required to access this resource"

        PaymentProcessed:
            description: Payment processed successfully
            content:
                application/json:
                    schema:
                        $ref: "#/components/schemas/Payment"

        RequiresAction:
            description: Additional action required (e.g., 3D Secure)
            content:
                application/json:
                    schema:
                        type: object
                        properties:
                            type:
                                type: string
                                enum: [three_d_secure_redirect, customer_action]
                            redirectUrl:
                                type: string
                                format: url
                            paymentIntent:
                                $ref: "#/components/schemas/PaymentIntent"
        WebhookVerified:
            description: Webhook received and verified
            headers:
                X-Webhook-Processed:
                    schema:
                        type: string
                        example: "true"

        RateLimited:
            description: Too many requests
            headers:
                Retry-After:
                    schema:
                        type: integer
                        description: Seconds to wait before retrying
            content:
                application/json:
                    schema:
                        type: object
                        properties:
                            code:
                                type: string
                                example: "rate_limited_exceeded"
                            message:
                                type: string
                                example: "Too many requests. Please try again later."

    securitySchemes:
        BearerAuth:
            type: http
            scheme: bearer
            bearerFormat: JWT
            description: Standard JWT authentication for API calls

        WebhookAuth:
            type: apiKey
            in: header
            name: X-Webhook-Secret
            description: Shared secret for webhook verification

    requestBodies:
        WebhookPayload:
            description: Webhook event from Payment processor
            required: true
            content:
                application/json:
                    schema:
                        $ref: "#/components/schemas/PaymentWebhook"

paths:
    # Payment Operations
    /payments:
        get:
            tags: [Payments]
            summary: List payments
            description: Retrieve a paginated list of payments with filters
            parameters:
                - $ref: "#/components/parameters/PaginationLimit"
                - $ref: "#/components/parameters/PaginationOffset"
                - $ref: "#/components/parameters/StatusFilter"
                - $ref: "#/components/parameters/CreatedAfter"
                - name: customerId
                  in: query
                  schema:
                      type: string
                      format: uuid
                - name: orderId
                  in: query
                  schema:
                      type: string
                      format: uuid
            responses:
                "200":
                    description: Successful response
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    data:
                                        type: array
                                        items:
                                            $ref: "#/components/schemas/Payment"
                                    hasMore:
                                        type: boolean
                                    total:
                                        type: integer
                "401":
                    $ref: "#/components/responses/Unauthorized"

        post:
            parameters:
                - $ref: "#/components/parameters/IdempotencyKey"
            tags: [Payments]
            summary: Create payment
            description: |
                Create a new payment. For card payments, use a payment method ID.
                For alternative payment methods, additional parameters may be required.

                ## Idempotency
                Include an `Idempotency-Key` header to prevent duplicate payments.
            security:
                - BearerAuth: []
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/CreatePaymentRequest"
            responses:
                "201":
                    $ref: "#/components/responses/PaymentProcessed"
                "202":
                    $ref: "#/components/responses/RequiresAction"
                "400":
                    description: Invalid request or payment failed
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    error:
                                        $ref: "#/components/schemas/PaymentError"
                "402":
                    description: Payment required (e.g., card declined)
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    error:
                                        $ref: "#/components/schemas/PaymentError"
                "409":
                    description: Duplicate request detected (use Idempotency-Key)
                "429":
                    $ref: "#/components/responses/RateLimited"

    /payments/{paymentId}:
        parameters:
            - $ref: "#/components/parameters/PaymentId"

        get:
            tags: [Payments]
            summary: Get payment by ID
            responses:
                "200":
                    description: Payment details
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Payment"
                "404":
                    $ref: "#/components/responses/NotFound"

        post:
            tags: [Payments]
            summary: Capture payment
            description: Capture a previously authorized payment
            security:
                - BearerAuth: []
            requestBody:
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                amount:
                                    type: integer
                                    description: Amount to capture (partial capture if less than authorized)
                                applicationFeeAmount:
                                    type: integer
                                statementDescriptor:
                                    type: string
                                    maxLength: 22
            responses:
                "200":
                    $ref: "#/components/responses/PaymentProcessed"
                "400":
                    description: Cannot capture (e.g., already captured, invalid amount)

    # Payment Intents (for client-side payment flows)
    /payment_intents:
        post:
            tags: [Payment Intents]
            summary: Create payment intent
            description: Create a PaymentIntent for client-side payment confirmation
            parameters:
                - $ref: '#/components/parameters/IdempotencyKey'   # required for create
            security:
                - BearerAuth: []
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            type: object
                            required:
                                - orderId
                                - amount
                                - currency
                            properties:
                                orderId:
                                    type: string
                                    format: uuid
                                amount:
                                    type: integer
                                currency:
                                    type: string
                                paymentMethodTypes:
                                    type: array
                                    items:
                                        type: string
                                captureMethod:
                                    type: string
                                    enum: [automatic, manual]
                                metadata:
                                    type: object
                                    additionalProperties:
                                        type: string
            responses:
                "201":
                    description: Payment intent created
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/PaymentIntent"
                "400":
                    description: Bad request (invalid order or mismatch)
                "409":
                    description: Reservation missing/expired or duplicate idempotency (see OUT_OF_STOCK, DUPLICATE_PAYMENT)

    /payment_intents/{paymentIntentId}/confirm:
        post:
            tags: [Payment Intents]
            summary: Confirm payment intent
            description: Confirm a PaymentIntent with payment method details
            parameters:
                - $ref: "#/components/parameters/PaymentIntentId"
                - $ref: '#/components/parameters/IdempotencyKey' # Idempotent confirm as well
            requestBody:
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                paymentMethodId:
                                    type: string
                                returnUrl:
                                    type: string
                                    format: uri
            responses:
                "200":
                    description: Payment processed (or requires action)
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/PaymentIntent"
                "202":
                    description: Requires additional action (3D Secure) â€” client must complete challenge
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    type:
                                        type: string
                                        enum: [three_d_secure_redirect, customer_action]
                                    redirectUrl:
                                        type: string
                                        format: url
                                    paymentIntent:
                                        $ref: "#/components/schemas/PaymentIntent"
                "402":
                    description: Payment failed (card declined, insufficient funds)
    
    /payments/{paymentId}/capture:
        post:
            tags: [Payments]
            summary: Capture an authorized payment (manual capture flow)
            parameters:
                - $ref: '#/components/parameters/PaymentId'
                - $ref: '#/components/parameters/IdempotencyKey'
            requestBody:
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                amount:
                                    type: integer
            responses:
                "200":
                    description: Capture successful
                "400":
                    description: Invalid capture request
                "409":
                    description: Already captured or invalid state

    # Refund Operations
    /refunds:
        post:
            tags: [Refunds]
            summary: Create refund
            description: Refund a captured payment (full or partial)
            security:
                - BearerAuth: []
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/CreateRefundRequest"
            responses:
                "201":
                    description: Refund created
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Refund"
                "400":
                    description: Cannot refund (e.g., payment not captured, amount exceeds available)

    /payments/{paymentId}/refunds:
        get:
            tags: [Refunds]
            summary: List refunds for payment
            parameters:
                - $ref: "#/components/parameters/PaymentId"
            responses:
                "200":
                    description: List of refunds
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    $ref: "#/components/schemas/Refund"

    # Payment Methods (Customer's saved payment methods)
    /customers/{customerId}/payment_methods:
        parameters:
            - $ref: "#/components/parameters/CustomerIdParam"

        get:
            tags: [Payment Methods]
            summary: List customer's payment methods
            responses:
                "200":
                    description: Payment methods
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    oneOf:
                                        - $ref: "#/components/schemas/CardPaymentMethod"
                                        - $ref: "#/components/schemas/PaymentMethod"

        post:
            tags: [Payment Methods]
            summary: Attach payment method to customer
            description: Add a new payment method for a customer
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            oneOf:
                                - type: object # Card payment method
                                  required: [type, card]
                                  properties:
                                      type:
                                          type: string
                                          enum: [card]
                                      card:
                                          type: object
                                          required:
                                              [number, expMonth, expYear, cvc]
                                          properties:
                                              number:
                                                  type: string
                                                  pattern: '^\d{13,19}$'
                                              expMonth:
                                                  type: integer
                                              expYear:
                                                  type: integer
                                              cvc:
                                                  type: string
                                                  pattern: '^\d{3,4}$'
                                - type: object # Payment method ID
                                  required: [paymentMethodId]
                                  properties:
                                      paymentMethodId:
                                          type: string
                                          format: uuid
            responses:
                "201":
                    description: Payment method attached
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/PaymentMethod"

    # Webhook Endpoint
    /webhooks:
        post:
            tags: [Webhooks]
            summary: Process payment provider webhooks
            description: |
                Receive and process webhook events from payment processors.

                ## Verification
                Webhooks must include a valid signature in the `X-Webhook-Signature` header.
            security:
                - WebhookAuth: []
            parameters:
                - name: provider
                  in: query
                  required: true
                  schema:
                      type: string
                      enum: [stripe, paypal, braintree]
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/PaymentWebhook"
            responses:
                "200":
                    $ref: "#/components/responses/WebhookVerified"
                "401":
                    description: Invalid webhook signature
                "400":
                    description: Invalid webhook payload

tags:
    - name: Payments
      description: Payment processing operations
    - name: Payment Intents
      description: Client-side payment flow operations
    - name: Refunds
      description: Refund management
    - name: Payment Methods
      description: Customer payment method management
    - name: Webhooks
      description: Webhook event processing

security:
    - BearerAuth: []
